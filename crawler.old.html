<!DOCTYPE html>
<style>

body{
  background:rgb(250,250,250);
  position:fixed;
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  color:rgb(51,51,51);
  font-weight:300;
}


.scrollable{
  overflow-x:hidden;
  overflow-y:scroll;
}
.title{
  background:rgb(203,78,78);
  color:rgb(255,255,255);
  border-bottom:1px solid rgb(153,28,28);
  text-align:center;
  line-height:50px;
  font-size:17px;
}


div.crawls{
  width:300px;
  height:100%;
  background:rgb(230,230,230);
  float:left;
}


div.crawls div.new{
  text-align:center;
  padding:14px 0px;
  margin:20px;
  border:1px dashed rgb(160,160,160);
  -webkit-border-radius: 12px;
  -moz-border-radius:    12px;
  border-radius:         12px;
  font-weight:400;
  font-size:15px;
  background:rgb(220,220,220);
  cursor:pointer;
}
div.crawls div.new:hover{
  background:rgb(210,210,210);
}
div.crawls div.line{
  border-bottom:1px solid rgb(200,200,200);
  box-shadow:0px 1px 0px rgb(255,255,255);
}


div.crawl{
  font-size:14px;
}
div.crawl div.button{
  padding:22px 0px;
  cursor:pointer;
  text-align:center;
  border-bottom:1px solid rgb(200,200,200);
  box-shadow:0px 1px 0px rgb(255,255,255);
}
div.crawl div.button:hover{
  background:rgb(220,220,220);
}
div.crawl div.button div{
  font-size:11px;
  color:rgb(102,102,102);
}


div.crawl div.preview{
  min-width:320px;
  position:absolute;
  left:300px;
  top:40px;
  z-index:999;
  padding-left:20px;
  display:none;
}
div.crawl div.preview div.frame{
  background:rgb(255,255,255);
  overflow:hidden;
  -webkit-border-radius: 12px;
  -moz-border-radius:    12px;
  border-radius:         12px;
  padding-bottom:25px;
  border-bottom:5px solid rgb(230,230,230);
  box-shadow:0px 0px 0px 8px rgba(255,255,255,0.5);
}
div.crawl:hover div.preview{
  display:block;
}
div.crawl div.preview h2{
  font-size:14px;
  font-weight:bold;
  padding:25px 0px 8px 20px;
  margin:0px;
}
div.crawl div.preview div.item{
  padding:2px 20px;
  text-align:right;
}
div.crawl div.preview div.item label{
  color:rgb(160,160,160);
  padding-right:10px;
  float:left;
}


div.download{
  width:200px;
  height:100%;
  background-color:rgb(230,230,230);
  overflow-x:visible;
  overflow-y:scroll;
  float:right;
}
div.download div.file{
  height:300px;
  width:200px;
  background:url(/images/fileicon.png) no-repeat;
  cursor:pointer;
}
div.download div.file div.size{
  color:rgb(160,160,160);
  text-align:center;
  padding-top:90px;
  font-size:16px;
  font-family:'Helvetica Neue';
  font-weight:100;
}


div.center{
  position:absolute;
  top:0px;
  left:300px;
  right:200px;
  height:100%;
  overflow:hidden;
}
div.center div.settings{
  height:40%;
}
div.center div.console{
  height:60%;
  position:relative;
}


div.console header{
  border:1px solid rgb(200,200,200);
  background:rgb(245,245,245);
  border-right:none;
  border-left:none;
  padding:2px 12px;
  font-size:16px;
}


div.console div.stats{
  position:absolute;
  top:51px;
  right:0px;
  bottom:0px;
  padding:20px 0px;
  width:280px;
}
div.console div.stats div.item{
  padding:2px 20px;
  text-align:right;
}
div.console div.stats div.item label{
  color:rgb(160,160,160);
  padding-right:10px;
  float:left;
}


div.console div.content{
  position:absolute;
  top:51px;
  left:0px;
  bottom:0px;
  padding:20px;
  right:280px;
  font-family: droid sans mono,monospace,courier new,courier,sans-serif;
  font-size:14px;
}



div.settings{
  position:relative;
  color:rgb(160,160,160);
}
div.settings div.inputs{
  position:absolute;
  top:0px;
  left:0px;
  right:300px;
  padding:20px;
}
div.settings div.input{
  padding:8px 0px;
}
div.settings div.input input{
  float:right;
  border:1px solid rgb(200,200,200);
  outline:none;
  color:rgb(51,51,51);
  padding:4px 7px;
  margin:0px;
  -webkit-border-radius: 2px;
  -moz-border-radius:    2px;
  border-radius:         2px;
  width:300px;
}
div.settings div.input input:hover{
  border:1px solid rgb(160,160,160);
}
div.settings div.input input:focus{
  border:1px solid #4285f4;
  box-shadow:0px 0px 1px #4285f4;
}


div.settings div.checkboxes{
  position:absolute;
  top:0px;
  right:0px;
  width:280px;
  padding:20px 20px 20px 0px;
}
div.checkbox{
  text-align:left;
  margin:8px 0px;
}
div.checkbox div.bool{
  display:inline-block;
  position:relative;
  padding:4px 17px;
  background:rgb(255,255,255);
  -webkit-border-radius: 2px;
  -moz-border-radius:    2px;
  border-radius:         2px;
  border:1px solid rgb(200,200,200);
  color:rgb(102,102,102);
}
div.checkbox div.bool input{
  position:absolute;
  top:0px;
  left:0px;
  width:100%;
  height:100%;
  margin:0px;
  outline:none;
  padding:0px;
  opacity:0;
  border:none;
  cursor:pointer;
}
div.checkbox div.bool input:checked~div.f,
div.checkbox div.bool div.t{
  display:none;
}
div.checkbox div.bool input:checked~div.t{
  display:block;
}


div.settings div.button{
  display:block;
  margin-top:50px;
  padding:8px 17px;
  border-bottom:3px solid rgb(120,120,120);
  -webkit-border-radius: 2px;
  -moz-border-radius:    2px;
  border-radius:         2px;
  background:rgb(160,160,160);
  color:rgb(255,255,255);
  outline:none;
  cursor:pointer;
  text-align:center;
  -webkit-touch-callout: none;
  -webkit-user-select: none;
  -khtml-user-select: none;
  -moz-user-select: none;
  -ms-user-select: none;
  user-select: none;
}
div.settings div.button:hover{
  border-bottom-width:2px;
  margin-top:51px;
}
div.settings div.button:active{
  border-bottom-width:1px;
  margin-top:52px;
}


div.settings div.frame{
  position:absolute;
  top:51px;
  right:0px;
  left:0px;
  bottom:0px;
}


</style>
<html lang='en'>
<head>
  
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"> 
<meta name="viewport" content="width=device-width, initial-scale=1"> 
<meta name="author" content="Hunter John Larco"/>
<meta name="description" content="The Craft of Tea Blog" />
<meta name="keywords" content="tea, blending, how to, craft, art, the art of, mixing, diy, make your own, oolong, green, white, chai, teavana, hunter larco, leaves"/>

<title>The Craft of Tea | Admin Pages</title>

<!-- **************** favicon **************** -->
<link rel='shortcut icon' type='image/x-icon' href='/images/favicon.ico' />


<!-- **************** stylesheets **************** -->
<link rel='stylesheet' href='/resources/css/reset.css'/>

<!-- **************** scripts **************** -->
<script type='text/javascript' src="/resources/scripts/classie.js"></script>
<script type='text/javascript' src="/resources/scripts/request.js"></script>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>

</head>
<body>




<div class='crawls scrollable'>
  <div class='title'>History</div>
  <div class='new'>Create New Crawl</div>
  <div class='line'></div>
  <div class='crawl'>
    <div class='button'>teavana.com<div>Sept. 14, 2014</div></div>
    <div class='preview'>
      <div class='frame'>
        <div class='title'>http://teavana.com/the-teas/</div>
        <h2>Settings</h2>
        <div class='item'><label>subdomains</label> www</div>
        <div class='item'><label>url match</label> /the-teas/[^/]+/?</div>
        <div class='item'><label>map naked domain to www</label> true</div>
        <div class='item'><label>strip url parameters</label> true</div>
        <h2>Metadata</h2>
        <div class='item'><label>completed</label> false</div>
        <div class='item'><label>queued tasks</label> 149</div>
        <div class='item'><label>completed tasks</label> 121</div>
        <div class='item'><label>active tasks</label> 28</div>
        <div class='item'><label>matches</label> 149</div>
        <div class='item'><label>file size</label> 8 kb</div>
        <div class='item'><label>run time</label> Sept. 4, 2014 13:00</div>
      </div>
    </div>
  </div>
  <div class='crawl'>
    <div class='button'>teavana.com<div>Sept. 14, 2014</div></div>
    <div class='preview'>
      <div class='frame'>
        <div class='title'>http://teavana.com/the-teas/</div>
        <h2>Settings</h2>
        <div class='item'><label>subdomains</label> www</div>
        <div class='item'><label>url match</label> /the-teas/[^/]+/?</div>
        <div class='item'><label>map naked domain to www</label> true</div>
        <div class='item'><label>strip url parameters</label> true</div>
        <h2>Metadata</h2>
        <div class='item'><label>completed</label> false</div>
        <div class='item'><label>queued tasks</label> 149</div>
        <div class='item'><label>completed tasks</label> 121</div>
        <div class='item'><label>active tasks</label> 28</div>
        <div class='item'><label>matches</label> 149</div>
        <div class='item'><label>file size</label> 8 kb</div>
        <div class='item'><label>run time</label> Sept. 4, 2014 13:00</div>
      </div>
    </div>
  </div>
  <div class='crawl'>
    <div class='button'>teavana.com<div>Sept. 14, 2014</div></div>
    <div class='preview'>
      <div class='frame'>
        <div class='title'>http://teavana.com/the-teas/</div>
        <h2>Settings</h2>
        <div class='item'><label>subdomains</label> www</div>
        <div class='item'><label>url match</label> /the-teas/[^/]+/?</div>
        <div class='item'><label>map naked domain to www</label> true</div>
        <div class='item'><label>strip url parameters</label> true</div>
        <h2>Metadata</h2>
        <div class='item'><label>completed</label> false</div>
        <div class='item'><label>queued tasks</label> 149</div>
        <div class='item'><label>completed tasks</label> 121</div>
        <div class='item'><label>active tasks</label> 28</div>
        <div class='item'><label>matches</label> 149</div>
        <div class='item'><label>file size</label> 8 kb</div>
        <div class='item'><label>run time</label> Sept. 4, 2014 13:00</div>
      </div>
    </div>
  </div>
  <div class='crawl'>
    <div class='button'>teavana.com<div>Sept. 14, 2014</div></div>
    <div class='preview'>
      <div class='frame'>
        <div class='title'>http://teavana.com/the-teas/</div>
        <h2>Settings</h2>
        <div class='item'><label>subdomains</label> www</div>
        <div class='item'><label>url match</label> /the-teas/[^/]+/?</div>
        <div class='item'><label>map naked domain to www</label> true</div>
        <div class='item'><label>strip url parameters</label> true</div>
        <h2>Metadata</h2>
        <div class='item'><label>completed</label> false</div>
        <div class='item'><label>queued tasks</label> 149</div>
        <div class='item'><label>completed tasks</label> 121</div>
        <div class='item'><label>active tasks</label> 28</div>
        <div class='item'><label>matches</label> 149</div>
        <div class='item'><label>file size</label> 8 kb</div>
        <div class='item'><label>run time</label> Sept. 4, 2014 13:00</div>
      </div>
    </div>
  </div>
  <div class='crawl'>
    <div class='button'>teavana.com<div>Sept. 14, 2014</div></div>
    <div class='preview'>
      <div class='frame'>
        <div class='title'>http://teavana.com/the-teas/</div>
        <h2>Settings</h2>
        <div class='item'><label>subdomains</label> www</div>
        <div class='item'><label>url match</label> /the-teas/[^/]+/?</div>
        <div class='item'><label>map naked domain to www</label> true</div>
        <div class='item'><label>strip url parameters</label> true</div>
        <h2>Metadata</h2>
        <div class='item'><label>completed</label> false</div>
        <div class='item'><label>queued tasks</label> 149</div>
        <div class='item'><label>completed tasks</label> 121</div>
        <div class='item'><label>active tasks</label> 28</div>
        <div class='item'><label>matches</label> 149</div>
        <div class='item'><label>file size</label> 8 kb</div>
        <div class='item'><label>run time</label> Sept. 4, 2014 13:00</div>
      </div>
    </div>
  </div>
  <div class='crawl'>
    <div class='button'>teavana.com<div>Sept. 14, 2014</div></div>
    <div class='preview'>
      <div class='frame'>
        <div class='title'>http://teavana.com/the-teas/</div>
        <h2>Settings</h2>
        <div class='item'><label>subdomains</label> www</div>
        <div class='item'><label>url match</label> /the-teas/[^/]+/?</div>
        <div class='item'><label>map naked domain to www</label> true</div>
        <div class='item'><label>strip url parameters</label> true</div>
        <h2>Metadata</h2>
        <div class='item'><label>completed</label> false</div>
        <div class='item'><label>queued tasks</label> 149</div>
        <div class='item'><label>completed tasks</label> 121</div>
        <div class='item'><label>active tasks</label> 28</div>
        <div class='item'><label>matches</label> 149</div>
        <div class='item'><label>file size</label> 8 kb</div>
        <div class='item'><label>run time</label> Sept. 4, 2014 13:00</div>
      </div>
    </div>
  </div>
</div>


<div class='download scrollable'>
  <div class='title'>Download</div>
  <div class='file'>
    <div class='size'>8 kb</div>
  </div>
</div>


<div class='center'>
  <div class='settings'>
    <div class='title'>Crawl Settings</div>
    <div class='frame scrollable'>
      <div class='inputs'>
        <div class='input'>base url <input            type='text' placeholder='https://teavana.com/the-teas/' id='settings_domain' /></div>
        <div class='input'>url match <input           type='text' placeholder='regex' value='.*'      id='settings_umatch' /></div>
        <div class='input'>included subdomains <input type='text' placeholder='regex' value='.*'      id='settings_isub'   /></div>
        <div class='input'>excluded subdomains <input type='text' placeholder='regex'                 id='settings_esub'   /></div>
        <div class='input'>included mimetypes <input  type='text' placeholder='regex' value='.*'      id='settings_imime'  /></div>
        <div class='input'>excluded mimetypes <input  type='text' placeholder='regex'                 id='settings_emime'  /></div>
      </div>
      <div class='checkboxes'>
        <div class='checkbox'>
          <div class='bool'>
            <input type='checkbox' checked id='mapnakeddomains'/>
            <div class='t'>true</div>
            <div class='f'>false</div>
          </div> map naked domain to www
        </div>
        <div class='checkbox'>
          <div class='bool'>
            <input type='checkbox' checked id='stripurls'/>
            <div class='t'>true</div>
            <div class='f'>false</div>
          </div> strip url parameters
        </div>
        <div class='button'>Queue Crawl</div>
      </div>
    </div>
  </div>
  
  <div class='console'>
    <div class='title'>Console</div>
    <div class='stats scrollable'>
      <div class='item'><label>completed</label> false</div>
      <div class='item'><label>queued tasks</label> 149</div>
      <div class='item'><label>completed tasks</label> 121</div>
      <div class='item'><label>active tasks</label> 28</div>
      <div class='item'><label>matches</label> 149</div>
      <div class='item'><label>file size</label> 8 kb</div>
      <div class='item'><label>run time</label> Sept. 4, 2014 13:00</div>
    </div>
    <div class='content scrollable'>
      crawling over teavana.com<br/>
      pending thios
    </div>
  </div>
</div>






















<script type='text/javascript'>






function OnQueueSuccess(event){
  console.log('queue set');
}

function OnQueueError(event){
  alert('Unable to Queue Job\n\nSee console for details.');
  event.error('Unable to Queue Job');
}

function QueueJob(domain, onupdate, onfinish){
  if(!channeltoken){
    ConnectToServer(function Callback(){
      console.log('channel connected')
      QueueJob(domain, onupdate, onfinish);
    });
    return;
  }
  Request('/admin/api/crawler/queue', {
    'domain': domain,
    'token': channeltoken
  }, OnQueueSuccess, {default:OnQueueError});
}







var channeltoken, channel;

var links = [];

function OnChannelMessage(event){
  var event = JSON.parse(event.data);
  if(event.type == 'page'){
    if(links.indexOf(event.page.location) > -1)
      console.error('Duplicate: '+event.page.location);
    else
      links.push(event.page.location);
  }else if(event.type == 'log'){
    console.log(event.log.message);
  }
}

function OnChannelError(event){
  event.description
}

function OnChannelClose(){
  
}






function OnConnection(event, callback){
  channeltoken = event.channel.token;
  channel = new goog.appengine.Channel(event.channel.key);
  socket = channel.open();
  socket.onopen = function(){
    if(typeof callback == 'function') callback();
  };
  socket.onmessage = OnChannelMessage;
  socket.onerror = OnChannelError;
  socket.onclose = OnChannelClose;
}

function OnConnectionError(event){
  alert('Unable To Connect To Server\n\nSee console for details.');
  event.error('Unable To Connect To Server');
}

function ConnectToServer(callback){
  Request('/admin/api/crawler/connect', {}, function(event){
    OnConnection(event, callback);
  }, {default:OnConnectionError});
}



















var Crawler = new (function(){
  var self = this;
  
  var elements = {
    'settings': {
      'inputs': {
        'domain': document.getElementById('settings_domain'),
        'urlmatch': document.getElementById('settings_umatch'),
        'includedsubdomains': document.getElementById('settings_isub'),
        'excludedsubdomains': document.getElementById('settings_esub'),
        'includedmimetypes': document.getElementById('settings_imime'),
        'excludedmimetypes': document.getElementById('settings_emime')
      },
      'checkboxes': {
        'mapnakeddomains': document.getElementById('mapnakeddomains'),
        'stripurls': document.getElementById('stripurls')
      }
    }
  }
  
  
  self.create = CreateCrawl;
  
  
  function CreateCrawl(){
    var crawl = new Crawl(
      elements.settings.inputs.domain.value,
      elements.settings.inputs.urlmatch.value,
      elements.settings.inputs.includedsubdomains.value,
      elements.settings.inputs.excludedsubdomains.value,
      elements.settings.inputs.includedmimetypes.value,
      elements.settings.inputs.excludedmimetypes.value,
      elements.settings.checkboxes.mapnakeddomains.checked,
      elements.settings.checkboxes.stripurls.checked
    );
    return crawl;
  }
  
})();

















var channel;

// event listeners
//    onmessage
function Channel(){
  var self = this;
  
  
  var server_token, client_token;
  var channel;
  
  var listeners = {};
  
  
  self.getServerToken = GetServerToken;
  self.getClientToken = GetClientToken;
  
  self.connect = Connect;
  self.listen = Listen;
  
  
  function Connect(callback){
    channel = channel.open({
      'onopen': function(){if(typeof callback == 'function') callback();},
      'onmessage': OnChannelMessage,
      'onerror': OnChannelError,
      'onclose': OnChannelClose
    });
  }
  function Listen(freq, listener){
    if (!listeners[freq]) listeners[freq] = [];
    listeners[freq].push(listener);
  }
  
  function OnChannelError(event){
    alert('Channel Error\n\nSee console for details.');
    console.warn('Channel Error: '+event.description);
  }
  function OnChannelClose(){
    alert('Channel Closed');
    console.warn('Channel Closed');
  }
  function OnChannelMessage(event){
    if(!listeners[event.frequency])
  }
  
  function GetServerToken(){
    return server_token;
  }
  function GetClientToken(){
    return client_token;
  }
  
  
  (function Constructor(client, server){
    client_token = client;
    server_token = server;
    channel = new goog.appengine.Channel(client_token);
  }).apply(self, arguments);
}


// event listeners
//    oncreated
//      ~ when a new crawl is created in the server
//    onconnect
//      ~ when the channel is connected to the crawl and verified
//    onverifyconnection
//      ~ when the channel is created a ping is sent to the server, this is the start of this process.
//    onping
//      ~ when a ping is sent
function Crawl(){
  var self = this;
  
  
  var settings = {};
  var listeners = {};
  
  var channelconstants = {};
  
  var key;
  
  
  self.queue = Queue;
  
  self.addEventListener = AddEventListener;
  self.removeEventListener = RemoveEventListener;
  self.__events__ = [];
  self.__events__.fire = FireEvent;
  
  
  function AddEventListener(event, funct){
    if(typeof event != 'string' || typeof funct != 'function') return;
    if(self.__events__.indexOf(event) == -1) self.__events__.push(event);
    if(!listeners[event]) listeners[event] = [];
    listeners[event].push(funct);
  }
  function RemoveEventListener(event, funct){
    if(typeof event != 'string' || typeof funct != 'function') return;
    if(self.__events__.indexOf(event) != -1) self.__events__.splice(self.__events__.indexOf(event), 1);
    if(!listeners[event]) return;
    var index = listeners[event].indexOf(funct);
    while(index>-1){
      listeners[event].splice(index, 1);
      index = listeners[event].indexOf(funct);
    }
  }
  function FireEvent(event, data){
    var data = data || {};
    if(!listeners[event]) return true;
    for(var i=0,funct; funct=listeners[event][i++];)
      if(funct(data) === false) return false;
    return true;
  }
  
  function OnCrawlCreationError(event){
    event.warn('Crawler Creation Error... Retrying');
    event.retry();
  }
  
  // shown in order of procedure
  function Queue(){
    Request('/admin/api/crawler/create', settings, function(event){
      self.__events__.fire('created');
      key = event.crawler.key;
      ConnectChannel(event.connection, function Callback(){
        VerifyConnection(InitializeQueue);
      });
    }, {default:OnCrawlCreationError});
  }
  function ConnectChannel(connectionevent, callback){
    if(!!channel) return __callback__();
    channel = new Channel(connectionevent.client, connectionevent.token);
    channelconstants = connectionevent.constants;
    channel.connect(__callback__);
    function __callback__(){
      channel.addEventListener('message', OnChannelMessage);
      self.__events__.fire('connect');
      if (typeof callback == 'function') callback();
    }
  }
  function VerifyConnection(callback){
    self.__events__.fire('verifyconnection');
    var interval, time = 1, recieved = false;
    
    channel.addEventListener('message', function(event){
      if(event.type != channelconstants.PING_RESPONSE || recieved) return;
      self.__events__.fire('connect');
      clearTimeout(interval);
      recieved = true;
      if(typeof callback == 'function') callback();
    });
    
    function SendPing(){
      Request('/admin/api/crawler/ping', {
        'key': key,
        'channel': channel.getServerToken()
      }, new Function(), {});
    }
    
    function RetryPing(){
      SendPing();
      var seconds = (Math.pow(2,time++)-1)*2;
      self.__events__.fire('ping', {
        seconds: seconds
      });
      interval = setTimeout(RetryPing, seconds*1000);
    }
    
    RetryPing();
  }
  function InitializeQueue(){
    console.log('Initializing');
  }
  
  function OnChannelMessage(event){
    // console.log(event);
  }
  
  
  (function Constructor(){
    settings = {
      'domain':             arguments[0],
      'urlmatch':           arguments[1],
      'includedsubdomains': arguments[2],
      'excludedsubdomains': arguments[3],
      'includedmimetypes':  arguments[4],
      'excludedmimetypes':  arguments[5],
      'mapnakeddomains':  arguments[6],
      'stripurls':  arguments[7]
    };
  }).apply(self, arguments);
}


</script>
</body>
</html>

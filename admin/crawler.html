<!DOCTYPE html>
<style>

</style>
<html lang='en'>
<head>
  
<meta charset="UTF-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge"> 
<meta name="viewport" content="width=device-width, initial-scale=1"> 
<meta name="author" content="Hunter John Larco"/>
<meta name="description" content="The Craft of Tea Blog" />
<meta name="keywords" content="tea, blending, how to, craft, art, the art of, mixing, diy, make your own, oolong, green, white, chai, teavana, hunter larco, leaves"/>

<title>The Craft of Tea | Admin Pages</title>

<!-- **************** favicon **************** -->
<link rel='shortcut icon' type='image/x-icon' href='/images/favicon.ico' />


<!-- **************** stylesheets **************** -->
<link rel='stylesheet' href='/resources/css/reset.css'/>

<!-- **************** scripts **************** -->
<script type='text/javascript' src="/resources/scripts/classie.js"></script>
<script type='text/javascript' src="/resources/scripts/request.js"></script>
<script type="text/javascript" src="/_ah/channel/jsapi"></script>

</head>
<body>



<script type='text/javascript'>






function OnQueueSuccess(event){
  console.log('queue set');
}

function OnQueueError(event){
  alert('Unable to Queue Job\n\nSee console for details.');
  event.error('Unable to Queue Job');
}

function QueueJob(domain, onupdate, onfinish){
  if(!channeltoken){
    ConnectToServer(function Callback(){
      console.log('channel connected')
      QueueJob(domain, onupdate, onfinish);
    });
    return;
  }
  Request('/admin/api/crawler/queue', {
    'domain': domain,
    'token': channeltoken
  }, OnQueueSuccess, {default:OnQueueError});
}







var channeltoken, channel;

var links = [];

function OnChannelMessage(event){
  var event = JSON.parse(event.data);
  if(event.type == 'page'){
    if(links.indexOf(event.page.location) > -1)
      console.error('Duplicate: '+event.page.location);
    else
      links.push(event.page.location);
  }else if(event.type == 'log'){
    console.log(event.log.message);
  }
}

function OnChannelError(event){
  event.description
}

function OnChannelClose(){
  
}






function OnConnection(event, callback){
  channeltoken = event.channel.token;
  channel = new goog.appengine.Channel(event.channel.key);
  socket = channel.open();
  socket.onopen = function(){
    if(typeof callback == 'function') callback();
  };
  socket.onmessage = OnChannelMessage;
  socket.onerror = OnChannelError;
  socket.onclose = OnChannelClose;
}

function OnConnectionError(event){
  alert('Unable To Connect To Server\n\nSee console for details.');
  event.error('Unable To Connect To Server');
}

function ConnectToServer(callback){
  Request('/admin/api/crawler/connect', {}, function(event){
    OnConnection(event, callback);
  }, {default:OnConnectionError});
}


</script>
</body>
</html>
